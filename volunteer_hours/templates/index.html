<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>QR Scanner Demo</title>
    </head>
    <body>
        <h1>Welcome! Please scan your QR code.</h1>
        <div id="video-container">
            <video id="qr-video"></video>
        </div>
        <div>
            <label>
                Highlight Style
                <select id="scan-region-highlight-style-select">
                    <option value="style-1">Style 1</option>
                    <option value="style-2">Style 2</option>
                </select>
            </label>
        </div>
        <div>
            <select id="inversion-mode-select">
                <option value="original">Scan original (dark QR code on bright background)</option>
                <option value="invert">Scan with inverted colors (bright QR code on dark background)</option>
                <option value="both">Scan both</option>
            </select>
            <br>
        </div>
        <div>
            <b>Preferred camera:</b>
            <select id="cam-list">
                <option value="environment" selected>Environment Facing (default)</option>
                <option value="user">User Facing</option>
            </select>
        </div>
        <br>
        <b>Detected QR code: </b>
        <span id="cam-qr-result">None</span>
        <hr>
        <div>
            <b>Event to sign in/out for</b>
            <br>
            <select name="Event" method="GET" action="/">
                {% for event in events %}
                    <option value="{{event}}">{{event}}</option>
                {% endfor %}
            </select>
            <br>
            <b>Sign in/out time</b>
            <br>
            <input type=="time" id="appt" name="appt" min="9:00" max="18:00" required>
        </div>
        <input type="submit" value="Submit">
        <script src="{{url_for('static', filename='js/qr-scanner/qr-scanner.umd.min.js')}}"></script>
        <script>
            const video = document.getElementById('qr-video');
            const videoContainer = document.getElementById('video-container');
            const camList = document.getElementById('cam-list');
            const camQrResult = document.getElementById('cam-qr-result');
            const fileSelector = document.getElementById('file-selector');
            
            function setResult(label, result) {
                console.log(result.data);
                label.textContent = result.data;
                label.style.color = 'teal';
                clearTimeout(label.highlightTimeout);
                label.highlightTimeout = setTimeout(() => label.style.color = 'inherit', 100);
            }
            
            // Web Cam Scanning
            const scanner = new QrScanner(video, result => setResult(camQrResult, result), {
                onDecodeError: error => {
                    camQrResult.textContent = error;
                    camQrResult.style.color = 'inherit';
                },
                highlightScanRegion: true,
                highlightCodeOutline: true,
            });
            
            scanner.start().then(() => {
                // List cameras after the scanner started to avoid listCamera's stream
                // and the scanner's stream being requested at the same time which can
                // result in listCamera's unconstrained stream also being offered to
                // the scanner. Note that we can also start the scanner after
                // listCameras, we just have it this way around in the demo to start
                // the scanner earlier.
                QrScanner.listCameras(true).then(cameras => cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.id;
                    option.text = camera.label;
                    camList.add(option);
                }));
            });
            
            // for debugging
            window.scanner = scanner;
            
            document.getElementById('scan-region-highlight-style-select').addEventListener('change', (e) => {
                videoContainer.className = e.target.value;
                scanner._updateOverlay(); // reposition the highlight because style 2 sets position: relative
            });
            
            document.getElementById('inversion-mode-select').addEventListener('change', event => {
                scanner.setInversionMode(event.target.value);
            });
            
            camList.addEventListener('change', event => {
                scanner.setCamera(event.target.value);
            });
        </script>
        <style>
            div {
            margin-bottom: 16px;
            }
            #video-container {
            line-height: 0;
            }
            #video-container.style-2 .scan-region-highlight-svg,
            #video-container.style-2 .code-outline-highlight {
            stroke: #64a2f3 !important;
            }
            hr {
            margin-top: 32px;
            }
        </style>
    </body>
</html>
